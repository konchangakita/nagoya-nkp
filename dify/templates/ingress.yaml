apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dify
  namespace: {{ .Release.Namespace }}
spec:
  ingressClassName: {{ required "expose.ingressClassName is required" .Values.expose.ingressClassName }}
  rules:
    - http:
        paths:
          # =========================
          # 1) API (dify-api)
          # =========================

          # Console API
          - path: /console/api
            pathType: Prefix
            backend:
              service:
                name: dify-api
                port:
                  number: 5001

          # Public API
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: dify-api
                port:
                  number: 5001

          # OpenAPI / LLM apps (often used)
          - path: /v1
            pathType: Prefix
            backend:
              service:
                name: dify-api
                port:
                  number: 5001

          # Files upload / generated artifacts
          - path: /files
            pathType: Prefix
            backend:
              service:
                name: dify-api
                port:
                  number: 5001

          # =========================
          # 2) Web UI routes (dify-web)
          #    NOTE: Protect /plugins from being swallowed by /plugin
          # =========================
          - path: /plugins
            pathType: Prefix
            backend:
              service:
                name: dify-web
                port:
                  number: 80

          # =========================
          # 3) Plugin Daemon (dify-plugin-daemon)
          #    NOTE: Make /plugin strict to avoid matching /plugins
          # =========================
          - path: /plugin
            pathType: Exact
            backend:
              service:
                name: dify-plugin-daemon
                port:
                  number: 5002

          - path: /plugin/
            pathType: Prefix
            backend:
              service:
                name: dify-plugin-daemon
                port:
                  number: 5002

          # =========================
          # 4) Web (catch-all)
          # =========================
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dify-web
                port:
                  number: 80
